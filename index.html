<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timer Viewer</title>

<!-- Socket.IO v2 –¥–ª—è DonationAlerts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.js"></script>

<style>
body{
  margin:0;
  background:transparent;
  overflow:hidden;
  font-family: Arial, sans-serif;
  user-select:none;
}

.timer-box{
  width:760px;
  padding:18px 22px;
  border-radius:26px;
  position:relative;
  color:#fff;
  background:rgba(10,10,20,0.50);
  backdrop-filter:blur(14px);
  border:1px solid rgba(255,255,255,0.14);
  box-shadow:0 12px 45px rgba(0,0,0,0.45);
}

.state-ok{box-shadow:0 0 25px rgba(0,255,180,0.3);}
.state-danger{box-shadow:0 0 25px rgba(255,120,80,0.4);}
.state-critical{box-shadow:0 0 30px rgba(255,40,40,0.6);}

.time{
  font-size:46px;
  font-weight:900;
  margin:10px 0;
}

.popup{
  margin-top:8px;
  display:inline-block;
  padding:6px 14px;
  border-radius:999px;
  font-size:16px;
  font-weight:800;
  opacity:0;
  transition:0.3s;
}

.popup.show{opacity:1;}
.popup.plus{color:#00ffc8;}
.popup.minus{color:#ff5050;}
</style>
</head>

<body>

<div class="timer-box state-ok" id="box">
  <div>‚è≥ –¢–∞–π–º–µ—Ä –¥–æ–Ω–∞—Ç–æ–≤</div>
  <div class="time" id="time">00:00:00</div>
  <div class="popup" id="popup">+1 –º–∏–Ω</div>
</div>

<script>

/* ===== –ù–ê–°–¢–†–û–ô–ö–ò ===== */
const CLIENT_ID = "17497";
const PRICE_PER_MINUTE = 50;
const MAX_SECONDS = 30 * 86400;

let secondsLeft = parseInt(localStorage.getItem("donate_timer_seconds")) || 0;

const timeEl = document.getElementById("time");
const popupEl = document.getElementById("popup");
const boxEl = document.getElementById("box");

/* ===== –§–û–†–ú–ê–¢ –í–†–ï–ú–ï–ù–ò ===== */
function formatTime(sec){
  const h = String(Math.floor(sec/3600)).padStart(2,"0");
  const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${h}:${m}:${s}`;
}

function updateUI(){
  timeEl.textContent = formatTime(secondsLeft);

  boxEl.classList.remove("state-ok","state-danger","state-critical");

  if(secondsLeft < 60) boxEl.classList.add("state-critical");
  else if(secondsLeft <= 600) boxEl.classList.add("state-danger");
  else boxEl.classList.add("state-ok");
}

setInterval(()=>{
  if(secondsLeft>0){
    secondsLeft--;
    localStorage.setItem("donate_timer_seconds",secondsLeft);
    updateUI();
  }
},1000);

updateUI();

/* ===== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===== */
if(window.location.hash.includes("access_token")){
  const params=new URLSearchParams(window.location.hash.substring(1));
  const accessToken=params.get("access_token");
  localStorage.setItem("donation_token",accessToken);
  window.location.hash="";
  alert("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
}

function donateLogin(){
  const redirectUri=window.location.origin+window.location.pathname;
  const authUrl=
  `https://www.donationalerts.com/oauth/authorize?client_id=${CLIENT_ID}`+
  `&redirect_uri=${redirectUri}`+
  `&response_type=token&scope=oauth-donation-index`;
  window.location.href=authUrl;
}

/* ===== SOCKET ===== */
const token=localStorage.getItem("donation_token");

if(token){

  const socket=io("https://socket.donationalerts.ru",{
    transports:["websocket"]
  });

  socket.on("connect",()=>{
    console.log("‚úÖ DonationAlerts –ø–æ–¥–∫–ª—é—á–µ–Ω");
    socket.emit("add-user",{token:token});
    socket.emit("join-channel",{token:token});
  });

  socket.on("donation",(msg)=>{
    console.log("üí∞ –î–æ–Ω–∞—Ç:",msg);

    const amount=msg.amount;
    const addedSeconds=Math.floor((amount/PRICE_PER_MINUTE)*60);

    secondsLeft=Math.min(secondsLeft+addedSeconds,MAX_SECONDS);
    localStorage.setItem("donate_timer_seconds",secondsLeft);

    popupEl.textContent=`+${Math.floor(addedSeconds/60)} –º–∏–Ω`;
    popupEl.classList.add("show","plus");

    setTimeout(()=>popupEl.classList.remove("show"),2000);

    updateUI();
  });

}else{
  console.warn("–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –í—ã–∑–æ–≤–∏ donateLogin() –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è –≤—Ö–æ–¥–∞.");
}

</script>
</body>
</html>
