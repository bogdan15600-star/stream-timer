<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Stream Timer</title>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #111;
        color: white;
        margin-top: 100px;
    }

    #timer {
        font-size: 60px;
        margin-top: 30px;
    }

    button {
        padding: 10px 20px;
        font-size: 18px;
        cursor: pointer;
    }
</style>
</head>
<body>

<h1>Stream Timer</h1>
<button id="loginBtn">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ DonationAlerts</button>

<div id="timer">00:00</div>

<script>

const CLIENT_ID = "17497"; // ‚Üê —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å —Å–≤–æ–π client_id

// ===================
// –û–ë–†–ê–ë–û–¢–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
// ===================

const hash = window.location.hash;

if (hash.includes("access_token")) {
    const params = new URLSearchParams(hash.substring(1));
    const accessToken = params.get("access_token");

    localStorage.setItem("donation_token", accessToken);
    window.location.hash = "";
    alert("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
}

document.getElementById("loginBtn").onclick = () => {
    const redirectUri = window.location.origin + window.location.pathname;

    const authUrl = `https://www.donationalerts.com/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${redirectUri}&response_type=token&scope=oauth-donation-index`;

    window.location.href = authUrl;
};

// ===================
// –¢–ê–ô–ú–ï–†
// ===================

let seconds = 0;
let timerInterval;

function startTimer() {
    timerInterval = setInterval(() => {
        seconds++;
        updateTimer();
    }, 1000);
}

function updateTimer() {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;

    document.getElementById("timer").innerText =
        String(mins).padStart(2, "0") + ":" +
        String(secs).padStart(2, "0");
}

startTimer();

// ===================
// WEBSOCKET
// ===================

const token = localStorage.getItem("donation_token");

if (token) {

    console.log("üîë –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");

    const socket = new WebSocket("wss://socket.donationalerts.ru:443");

    socket.onopen = () => {
        console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω");

        socket.send(JSON.stringify({
            type: "subscribe",
            channel: `private-donations.${token}`
        }));
    };

    socket.onmessage = (event) => {
        console.log("üì© –°–æ–æ–±—â–µ–Ω–∏–µ:", event.data);

        try {
            const data = JSON.parse(event.data);

            if (data.type === "donation") {
                const amount = data.data.amount;
                console.log("üí∞ –î–æ–Ω–∞—Ç:", amount);

                // –ø—Ä–∏–º–µ—Ä: –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã –∫ —Ç–∞–π–º–µ—Ä—É
                seconds += 60; 
                updateTimer();
            }

        } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ JSON:", e);
        }
    };

    socket.onerror = (error) => {
        console.error("üö® WebSocket –æ—à–∏–±–∫–∞:", error);
    };

    socket.onclose = (event) => {
        console.error("üîå WebSocket –∑–∞–∫—Ä—ã—Ç");
        console.log("–ö–æ–¥:", event.code);
        console.log("–ü—Ä–∏—á–∏–Ω–∞:", event.reason);
    };

} else {
    console.warn("‚ö†Ô∏è –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –ù—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.");
}

</script>

</body>
</html>
