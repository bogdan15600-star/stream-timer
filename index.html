<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Stream Timer</title>

<!-- Socket.IO v2 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #111;
        color: white;
        margin-top: 100px;
    }

    #timer {
        font-size: 60px;
        margin-top: 30px;
    }

    button {
        padding: 10px 20px;
        font-size: 18px;
        cursor: pointer;
    }
</style>
</head>
<body>

<h1>Stream Timer</h1>
<button id="loginBtn">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ DonationAlerts</button>
<div id="timer">00:00</div>

<script>

const CLIENT_ID = "17497";
const PRICE_PER_MINUTE = 50;

let totalSeconds = 0;

// ===================
// –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
// ===================

if (window.location.hash.includes("access_token")) {
    const params = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = params.get("access_token");

    localStorage.setItem("donation_token", accessToken);
    window.location.hash = "";
    alert("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
}

document.getElementById("loginBtn").onclick = () => {
    const redirectUri = window.location.origin + window.location.pathname;

    const authUrl =
        `https://www.donationalerts.com/oauth/authorize?client_id=${CLIENT_ID}` +
        `&redirect_uri=${redirectUri}` +
        `&response_type=token` +
        `&scope=oauth-donation-index`;

    window.location.href = authUrl;
};

// ===================
// –¢–ê–ô–ú–ï–†
// ===================

function updateTimer() {
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;

    document.getElementById("timer").innerText =
        String(mins).padStart(2, "0") + ":" +
        String(secs).padStart(2, "0");
}

setInterval(() => {
    if (totalSeconds > 0) {
        totalSeconds--;
        updateTimer();
    }
}, 1000);

// ===================
// SOCKET.IO
// ===================

const token = localStorage.getItem("donation_token");

if (token) {

    console.log("üîë –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");

    const socket = io("https://socket.donationalerts.ru", {
        transports: ["websocket"]
    });

    socket.on("connect", () => {
        console.log("‚úÖ Socket.IO –ø–æ–¥–∫–ª—é—á–µ–Ω");

        // –í–ê–ñ–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
        socket.emit("add-user", { token: token });
        socket.emit("join-channel", { token: token });
    });

    socket.on("donation", function(msg) {
        console.log("üí∞ –ù–æ–≤—ã–π –¥–æ–Ω–∞—Ç:", msg);

        const amount = msg.amount;
        const minutes = amount / PRICE_PER_MINUTE;

        totalSeconds += Math.floor(minutes * 60);
        updateTimer();
    });

    socket.on("connect_error", function(err) {
        console.error("üö® –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:", err);
    });

    socket.on("disconnect", function() {
        console.warn("üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ");
    });

} else {
    console.warn("‚ö†Ô∏è –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –ù—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.");
}

</script>

</body>
</html>
